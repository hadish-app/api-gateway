# Rate Limiting Settings
limit_req_zone $binary_remote_addr zone=admin_limit:10m rate=10r/s;
limit_req_status 429;

# IP Blacklist Settings
lua_shared_dict ip_blacklist 10m;
lua_shared_dict rate_limit_count 10m;

# Include banned IPs configuration
include /etc/nginx/banned_ips.conf;

# Security Headers
map $status $security_headers {
    default "default-src 'self';script-src 'self';style-src 'self' 'unsafe-inline';img-src 'self' data: https:;base-uri 'self';font-src 'self' https: data:;form-action 'self';frame-ancestors 'self';object-src 'none';script-src-attr 'none';upgrade-insecure-requests";
}

# Security Response Headers
add_header Content-Security-Policy $security_headers always;
add_header X-Frame-Options "DENY" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always; 