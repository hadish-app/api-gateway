# Enhanced Logging Settings with Milliseconds
map $msec $millisec {
    "~^(?<sec>\d+)\.(?<ms>\d+)$" $ms;
}

map $time_iso8601 $timestamp {
    "~^(?<dt>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})\+(?<tz>\d{2}:\d{2})$" "$dt.$millisec+$tz";
}

# Main Extended Log Format
log_format main_ext escape=json '[$timestamp] $remote_addr - $remote_user '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent" '
                   'forwarded_for="$http_x_forwarded_for" '
                   'req_time=$request_time '
                   'upstream_time="$upstream_response_time" '
                   'upstream_status="$upstream_status" '
                   'host="$host" '
                   'server_port="$server_port" '
                   'request_id="$request_id"';

# Security Events Log Format
log_format security escape=json '[$timestamp] $remote_addr '
                   'client="$http_user_agent" '
                   'forwarded_for="$http_x_forwarded_for" '
                   'request="$request" '
                   'status=$status '
                   'violation_type="$violation_type" '
                   'details="$details" '
                   'request_id="$request_id"';

# Define what should be logged in security log
map $status $loggable {
    ~^[45] 1;
    default 0;
}

# Log File Settings
access_log /var/log/nginx/access.log main_ext buffer=4k flush=1s;
access_log /var/log/nginx/security.log security if=$loggable buffer=4k flush=1s;
error_log /var/log/nginx/error.log debug; 