# =============================================================================
# Integration Test Endpoints
# =============================================================================

location ~ ^/tests/(.+) {
    default_type 'text/plain';
    access_by_lua_block {
        -- Capture the test path
        local test_path = ngx.var[1]
        ngx.log(ngx.DEBUG, "Running test: ", test_path)
        
        -- Load the test module
        local test_module = require("tests." .. test_path)
        local test_utils = require "tests.core.test_utils"
        
        -- Set initial status before any output
        -- ngx.status = 200
        
        -- Run the test suite
        test_utils.run_suite(test_path, test_module.tests)
        
        -- Run cleanup if available
        if test_module.after_all then
            ngx.log(ngx.DEBUG, "Running after_all cleanup for: ", test_path)
            local ok, err = pcall(test_module.after_all)
            if not ok then
                ngx.log(ngx.ERR, "Cleanup failed: ", err)
            end
        end
    }
} 