# =============================================================================
# Integration Test Endpoints
# =============================================================================

location ~ ^/tests/(.+) {
    default_type 'text/plain';
    access_by_lua_block {
        -- Capture the test path
        local test_path = string.gsub(ngx.var[1], "%.lua$", "")
        ngx.log(ngx.DEBUG, "Running test: ", test_path)
        
        -- Load the test module
        local test_module = require("tests." .. test_path)
        local test_utils = require "tests.core.test_utils"
        
        -- Run the test suite
        test_utils.run_suite(test_path, test_module.tests, test_module.before_all, test_module.before_each, test_module.after_each, test_module.after_all)
    }
}

location = /tests/all {
    default_type 'text/plain';
    
    # Maximize buffer settings
    proxy_buffering off;
    proxy_buffer_size 512k;
    proxy_buffers 16 512k;
    proxy_busy_buffers_size 1m;
    client_body_buffer_size 1m;
    client_max_body_size 100m;
    
    access_by_lua_block {
        local test_runner = require "tests.core.test_runner"
        local test_utils = require "tests.core.test_utils"
        
        -- Find and run all tests
        local failed_tests = test_runner.run_all_tests(ngx.config.prefix() .. "tests/modules")
        
        if #failed_tests > 0 then
            ngx.log(ngx.ERR, "Some tests failed: ", table.concat(failed_tests, ", "))
            ngx.status = 500
        end
    }
}

