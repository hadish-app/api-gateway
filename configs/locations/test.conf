# =============================================================================
# Integration Test Endpoints
# =============================================================================

# Module tests
location ~ ^/test/modules/(?<module>[^/]+)/(?<test_name>[^/]+)$ {
    default_type 'text/plain';
    access_by_lua_block {
        -- Run middleware chain first
        local middleware_chain = require "modules.core.middleware_chain"
        local ok, err = pcall(function()
            return middleware_chain.run(ngx.var.uri)
        end)
        
        if not ok then
            ngx.log(ngx.ERR, "Middleware chain error: ", err)
            ngx.status = 500
            ngx.say("Internal Server Error")
            ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
        end
        
        -- If chain returns false, stop processing
        if err == false then
            ngx.exit(ngx.HTTP_OK)
            return
        end
    }
    content_by_lua_block {
        local test_utils = require "tests.core.test_utils"
        local test_module = require("tests.modules." .. ngx.var.module .. "." .. ngx.var.test_name)
        test_utils.run_suite(ngx.var.test_name, test_module.tests)
    }
} 