# Admin API
# ---------------------------------------------------------------------
location /admin/ {
    # Apply admin-specific middleware
    access_by_lua_block {
        local middleware = require "middleware"
        local ctx = middleware.new_context()

        -- Validate backend configuration
        if not middleware.run(ctx, "backend_validation") then
            return
        end

        -- Handle admin access
        if not middleware.run(ctx, "admin_access") then
            return
        end
    }

    # URL rewriting for all admin endpoints
    rewrite ^/admin/(.*) /api/$1 break;

    # Forward to backend
    proxy_pass $backend;
} 