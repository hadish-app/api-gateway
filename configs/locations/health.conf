# Health Check Endpoints
# ---------------------------------------------------------------------

# Basic health check
location /health {
    access_by_lua_block {
        -- Run middleware chain first
        local middleware_chain = require "modules.core.middleware_chain"
        local ok, err = pcall(function()
            return middleware_chain.run(ngx.var.uri)
        end)
        
        if not ok then
            ngx.log(ngx.ERR, "Middleware chain error: ", err)
            ngx.status = 500
            ngx.say("Internal Server Error")
            ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
        end
        
        -- If chain returns false, stop processing
        if err == false then
            ngx.exit(ngx.HTTP_OK)
            return
        end

        -- Continue with health check
        require("modules.services.health").check()
    }
}

# Detailed health check
location /health/details {
    access_by_lua_block {
        -- Run middleware chain first
        local middleware_chain = require "modules.core.middleware_chain"
        local ok, err = pcall(function()
            return middleware_chain.run(ngx.var.uri)
        end)
        
        if not ok then
            ngx.log(ngx.ERR, "Middleware chain error: ", err)
            ngx.status = 500
            ngx.say("Internal Server Error")
            ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
        end
        
        -- If chain returns false, stop processing
        if err == false then
            ngx.exit(ngx.HTTP_OK)
            return
        end

        -- Continue with detailed health check
        require("modules.services.health").check_detailed()
    }
} 