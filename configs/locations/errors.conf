# Error Handling (for non-admin routes)
# ---------------------------------------------------------------------
error_page 404 @404_json;
error_page 403 @403_json;
error_page 500 502 503 504 @5xx_json;

# JSON Error Handlers (for non-admin routes)
location @404_json {
    internal;
    content_by_lua_block {
        local middleware = require "middleware"
        local ctx = middleware.new_context()

        -- Apply error handling middleware
        middleware.run(ctx, "error_tracking")

        -- Handle 404 response
        local response = require "handlers.errors"
        response.handle_not_found(ctx)
    }
}

location @403_json {
    internal;
    content_by_lua_block {
        local middleware = require "middleware"
        local ctx = middleware.new_context()

        -- Apply error handling middleware
        middleware.run(ctx, "error_tracking")

        -- Handle 403 response
        local response = require "handlers.errors"
        response.handle_forbidden(ctx)
    }
}

location @5xx_json {
    internal;
    content_by_lua_block {
        local middleware = require "middleware"
        local ctx = middleware.new_context()

        -- Apply error handling middleware
        middleware.run(ctx, "error_tracking")

        -- Handle server error response
        local response = require "handlers.errors"
        response.handle_server_error(ctx)
    }
} 