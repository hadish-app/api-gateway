# Lua Configuration
# -----------------------------------------------------------------------------
# Module search paths
lua_package_path "/usr/local/openresty/lualib/?.lua;/usr/local/openresty/nginx/modules/?.lua;/usr/local/openresty/nginx/modules/*/?.lua;;";

# Shared memory zones
lua_shared_dict metrics 10m;           # Metrics storage
lua_shared_dict rate_limit_store 10m;  # Rate limiting storage
lua_shared_dict config 1m;             # Configuration storage
lua_shared_dict ip_blacklist 5m;       # IP ban storage
lua_shared_dict stats 1m;              # Runtime statistics

# Lua initialization
init_by_lua_block {
    -- Initialize UUID generator
    local uuid = require "resty.jit-uuid"
    uuid.seed()  -- Properly seed the UUID generator

    -- Initialize start time for uptime tracking
    local stats = ngx.shared.stats
    stats:set("start_time", ngx.now())
}

init_worker_by_lua_block {
    -- Initialize rate limiter
    local rate_limit = require "middleware.rate_limit"
    rate_limit.init()

    -- Initialize health check stats
    local health_check = require "middleware.health_check"
    health_check.init_worker()
}

# Log phase handler to update request stats
log_by_lua_block {
    local health_check = require "middleware.health_check"
    if health_check.update_stats then
        health_check.update_stats()
    end
} 