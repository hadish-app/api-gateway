
[0;34m=== Starting API Gateway Tests ===[0m

This test will verify:
1. Rate limiting (10 req/s with burst of 5)
2. IP banning after 3 rate limit violations
3. 10-second ban duration
4. Automatic unbanning

[0;34m=== Phase 1: Testing Rate Limiting ===[0m

Making rapid requests to trigger rate limiting...
Rate limit is set to 10 req/s with burst of 5
You should see [0;31m429[0m responses after exceeding the limit

Request 1: [0;32mOK (200)[0m
Request 2: [0;32mOK (200)[0m
Request 3: [0;32mOK (200)[0m
Request 4: [0;32mOK (200)[0m
Request 5: [0;32mOK (200)[0m
Request 6: [0;32mOK (200)[0m
Request 7: [0;32mOK (200)[0m
Request 8: [0;31mRate Limited (429) - Violation 1/3[0m
Request 9: [0;31mRate Limited (429) - Violation 2/3[0m
Request 10: [0;32mOK (200)[0m
Request 11: [0;31mRate Limited (429) - Violation 3/3[0m
Request 12: [0;31mIP Banned (403)[0m

[0;34m=== Phase 2: Verifying IP Ban ===[0m

[0;32mâœ“ IP is banned (found in banned_ips.conf)[0m

[1;33mCurrent banned_ips.conf contents:[0m
# Banned IPs Configuration
# Format: deny IP_ADDRESS;

# Auto-generated - DO NOT EDIT
# Ban Start: 2024-12-04 15:31:09
# Ban Until: 2024-12-04 15:31:19
geo $banned_ip {
    default 0;
    172.26.0.1 1;
}

map $banned_ip $banned_response {
    0 '';
    1 '{"error": "IP temporarily banned due to excessive requests. Try again in 10 seconds."}';
}

[0;34m=== Phase 3: Testing Ban Duration ===[0m

Ban duration is set to 10 seconds
Making requests every 2 seconds to monitor ban status...

Time elapsed: 0s
[0;31mâœ— Request denied (403) - IP is still banned[0m

Time elapsed: 2s
[0;31mâœ— Request denied (403) - IP is still banned[0m

Time elapsed: 4s
[0;31mâœ— Request denied (403) - IP is still banned[0m

Time elapsed: 6s
[0;31mâœ— Request denied (403) - IP is still banned[0m

Time elapsed: 8s
[0;31mâœ— Request denied (403) - IP is still banned[0m

Time elapsed: 10s
[0;32mâœ“ Request allowed (200) - Ban has been lifted[0m

Time elapsed: 12s
[0;32mâœ“ Request allowed (200) - Ban has been lifted[0m

Time elapsed: 14s
[0;32mâœ“ Request allowed (200) - Ban has been lifted[0m

[0;34m=== Final Status Check ===[0m

Making final request to verify ban is lifted:
{"status":"ok","message":"Healthy","dbLatency":1.160625,"eventStoreLatency":11.114375,"documentDbLatency":7.555042,"dbMessage":"Database is connected","eventStoreMessage":"EventStore is connected","documentDbMessage":"DocumentDB is connected","uptime":12518.327726999,"timestamp":"2024-12-04T15:31:25.657Z"}
Status Code: 200

[0;34m=== Test Summary ===[0m

1. Rate Limiting: Successfully triggered after rapid requests
2. IP Banning: Successfully banned after 3 violations
3. Ban Duration: Ban was lifted after approximately 10 seconds
4. Current Status: [0;32mUnbanned[0m

[1;33mRecent security log entries:[0m
[2024-12-04T15:31:09.358+00:00] 172.26.0.1 client="curl/8.7.1" forwarded_for="" request="GET /admin/health HTTP/1.1" status=403 violation_type="BANNED_IP" details="Request from banned IP" request_id="c9c40a76cb17c89e1dee80dfe4617bb7"
[2024-12-04T15:31:11.389+00:00] 172.26.0.1 client="curl/8.7.1" forwarded_for="" request="GET /admin/health HTTP/1.1" status=403 violation_type="BANNED_IP" details="Request from banned IP" request_id="565de27e1e572cdfdf777bd13a908929"
[2024-12-04T15:31:13.411+00:00] 172.26.0.1 client="curl/8.7.1" forwarded_for="" request="GET /admin/health HTTP/1.1" status=403 violation_type="BANNED_IP" details="Request from banned IP" request_id="963a9ee09782c88e0ae2883415b8aeaf"
[2024-12-04T15:31:15.430+00:00] 172.26.0.1 client="curl/8.7.1" forwarded_for="" request="GET /admin/health HTTP/1.1" status=403 violation_type="BANNED_IP" details="Request from banned IP" request_id="dcc6a6ce079f8dbf86e76f8b4a3f5e2f"
[2024-12-04T15:31:17.451+00:00] 172.26.0.1 client="curl/8.7.1" forwarded_for="" request="GET /admin/health HTTP/1.1" status=403 violation_type="BANNED_IP" details="Request from banned IP" request_id="daacadfec35817d66b3803c36eaeca25"
